---
layout:     post 
slug:      "new-container-image-registry-from-cncf"
title:      "新的容器镜像仓库选择"
subtitle:   ""
description: ""
date:       2023-01-18
author:     "梁远鹏"
image: "img/post-bg-2015.jpg"
published: true
tags:
    - zot 
    - cncf
categories: [ CloudNative ]
---

# 简介

Zot 是思科开源的遵循 OCI 规范的容器镜像仓库,目前捐赠给了 CNCF,是 Sandbox 级别项目.

# lank8s案例

目前 lank8s 服务已经将部分流量从 distribution 仓库切换到了 Zot 镜像仓库.对于 lank8s 来说,Zot 的一个比较大的吸引力是可以对多个容器镜像仓库代理,在 Distribution 的 repo 中早有人提了这个功能 issue,但是一直没有人来实现这部分内容.

```json
{
    "extensions": {
        "scrub": {
            "enable": true,
            "interval": "3h"
        },
        "sync": {
            "enable": true,
            "registries": [
                {
                    "urls": [
                        "https://gcr.lank8s.cn"
                    ],
                    "onDemand": true,
                    "tlsVerify": true,
                    "maxRetries": 2,
                    "retryDelay": "5m",
                    "content": [
                    {
                        "prefix": "/lank8s"
                    }]
                },
                {
                    "urls": [
                        "https://k8s.lank8s.cn"
                    ],
                    "onDemand": true,
                    "tlsVerify": true,
                    "maxRetries": 2,
                    "retryDelay": "5m"
                },
                {
                    "urls": [
                        "https://registry.lank8s.cn"
                    ],
                    "onDemand": true,
                    "tlsVerify": true,
                    "maxRetries": 2,
                    "retryDelay": "5m"
                }
            ]
        }
    }
}
```

上面的配置示例是当拉取镜像时(例如kube-proxy:v1.26.0)如果 Zot 本地没有镜像信息则会同时从上游`k8s.lank8s.cn`和`registry.lank8s.cn`,
拉取,为什么没有从另一个上游`gcr.lank8s.cn`拉取镜像呢?是因为在字段`content`中配置了`prefix`,只有前缀为 `/lank8s` 的请求才会从上游 `gcr.lank8s.cn` 拉取镜像.

用户体验不太友好的是,当从上游同步镜像时是阻塞整个镜像下载过程的,需要等待 Zot 将镜像从上游整个下载到本地之后,才会让客户端继续镜像的下载.而 Distribution 是分步同步的,因此可以很快的给到客户端响应,用户体验会相对较好.

另一个点是作为镜像代理模式工作时不支持S3存储.

# 注意 

本文还在持续创作当中.