---
layout:     post 
slug:      "new-container-image-registry-from-cncf"
title:      "新的容器镜像仓库选择"
subtitle:   ""
description: ""
date:       2023-01-18
author:     "梁远鹏"
image: "img/post-bg-2015.jpg"
published: true
tags:
    - zot 
    - cncf
categories: [ CloudNative ]
---

# 简介

Zot 是思科开源的遵循 OCI 规范的容器镜像仓库,目前捐赠给了 CNCF,是 Sandbox 级别项目.

本文主要讲述作为镜像代理仓库下的应用场景.

# 部署

## Kubernetes

### 前提

- helm
- kubernetes cluster

这里使用 kind 来创建一个研究用的 K8S 单节点集群.

TODO 
配置了 gcr.io 和 k8s.gcr.io 和 registry.k8s.io 镜像加速的 kind 配置.
配置一个固定的端口映射,用于访问 kind k8s 中的 zot


```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
# featureGates:
#   "ValidatingAdmissionPolicy": true
#   "AggregatedDiscoveryEndpoint": true
# runtimeConfig:
#   "api/alpha": "true"
networking:
  apiServerAddress: "0.0.0.0"
  apiServerPort: 6443
containerdConfigPatches:
- |-
  [plugins."io.containerd.grpc.v1.cri".registry.mirrors."gcr.io"]
    endpoint = ["https://gcr.lank8s.cn"]
  [plugins."io.containerd.grpc.v1.cri".registry.mirrors."k8s.gcr.io"]
    endpoint = ["https://k8s.lank8s.cn"]
  [plugins."io.containerd.grpc.v1.cri".registry.mirrors."registry.k8s.io"]
    endpoint = ["https://registry.lank8s.cn"]
  [plugins."io.containerd.grpc.v1.cri".registry.mirrors."ghcr.io"]
    endpoint = ["https://ghcr.lank8s.cn"]
nodes:
- role: control-plane
  extraMounts:
  - hostPath: /var/log/tmp
    containerPath: /var/log
  extraPortMappings:
  - containerPort: 5000
    hostPort: 31150
    listenAddress: "0.0.0.0"
```

本文使用的版本是

k8s 1.25.2

```shell
CHART           APP VERSION
zot-0.1.18      v2.0.0-rc2 
```

### 开始部署

这里使用官方的 helm chart 来部署 zot,
```shell
helm repo add project-zot http://zotregistry.io/helm-charts
helm install zot project-zot/zot
```

TODO
配置固定的 nodePort 端口号,用于测试访问.

使用默认的配置来部署zot,


# 开启认证

默认情况下,所有用户都可以做任何操作,包括 读取/创建/更新/删除,在镜像代理仓库的场景下,这显然是不合理的,匿名用户只需要具备读权限即可.而管理员则具备其他权限,例如删除操作.

# 扩展

  "extensions": {
    "metrics": {},
    "sync": {},
    "search": {},
    "scrub": {},
    "lint": {}
  }


# lank8s案例

目前 lank8s 服务已经从 distribution 仓库切换到了 Zot 镜像仓库.对于 lank8s 来说,Zot 的一个比较大的吸引力是可以对多个容器镜像仓库代理,在 Distribution 的 repo 中早有人提了这个功能 issue,但是一直没有人来实现这部分内容.

```json
{
    "extensions": {
        "scrub": {
            "enable": true,
            "interval": "3h"
        },
        "sync": {
            "enable": true,
            "registries": [
                {
                    "urls": [
                        "https://gcr.lank8s.cn"
                    ],
                    "onDemand": true,
                    "tlsVerify": true,
                    "maxRetries": 2,
                    "retryDelay": "5m",
                    "content": [
                    {
                        "prefix": "/google-containers/*"
                    }]
                },
                {
                    "urls": [
                        "https://k8s.lank8s.cn"
                    ],
                    "onDemand": true,
                    "tlsVerify": true,
                    "maxRetries": 2,
                    "retryDelay": "5m"
                },
                {
                    "urls": [
                        "https://registry.lank8s.cn"
                    ],
                    "onDemand": true,
                    "tlsVerify": true,
                    "maxRetries": 2,
                    "retryDelay": "5m"
                }
            ]
        }
    }
}
```

上面的配置示例是当拉取镜像时(例如kube-proxy:v1.26.0)如果 Zot 本地没有镜像信息则会同时从上游`k8s.lank8s.cn`和`registry.lank8s.cn`,
拉取,为什么没有从另一个上游`gcr.lank8s.cn`拉取镜像呢?是因为在字段`content`中配置了`prefix`,只有前缀为 `google-containers` 的容器镜像才会从上游 `gcr.lank8s.cn` 拉取镜像.

## 初体验

### 用户不友好
- 当从上游同步镜像时是阻塞整个镜像下载过程的,需要等待 Zot 将镜像从上游整个下载到本地之后,才会让客户端继续镜像的下载.而 Distribution 是分步同步的,因此可以很快的给到客户端响应,用户体验会相对较好.

- 作为镜像代理模式工作时不支持S3存储.

- 同步多个上游镜像源时无法分开存储,例如上游 1 的数据存储在路径 A,上游 2 的数据存储在路径 B. 配置了 zot 中的 subpaths,不过似乎不起作用.

# 注意 

本文还在持续创作当中.