---
layout:     post 
slug:      "quick-know-dapr"
title:      "快速认识Dapr"
subtitle:   ""
description: ""
date:       2022-12-29
author:     "梁远鹏"
image: "img/post-bg-2015.jpg"
published: false
tags:
    - dapr 
    - cncf
categories: [ CloudNative ]
---

# 前言

可以从 Dapr 的示例仓库 https://github.com/dapr/quickstarts 开始 Dapr 的 Hello World.  

其中又有很多功能以及语言的实例，我们从 Java 的服务调用开始了解示例.

前提:
启动了 Dapr.

执行下面命令用于启动 Dapr:
```shell
dapr init
```

找到仓库中的 service_invocation/java/http,会有两个项目:

- order-processor  服务提供者
- checkout         服务消费者

首先启动服务提供者:

```shell
cd order-processor
mvn clean install
dapr run --app-id order-processor --app-port 9001 --app-protocol http --dapr-http-port 3501 -- java -jar target/OrderProcessingService-0.0.1-SNAPSHOT.jar
```

打开一个新的窗口,启动消费者:
```shell
cd checkout
mvn clean install
dapr run --app-id checkout --app-protocol http --dapr-http-port 3500 -- java -jar target/CheckoutService-0.0.1-SNAPSHOT.jar
```


如无意外那么你会看到如下日志:

服务提供者:
```shell
INFO[0002] placement tables updated, version: 0          app_id=order-processor instance=fv-az183-232 scope=dapr.runtime.actor.internal.placement type=log ver=1.9.5
== APP == Order received: 1
== APP == Order received: 2
== APP == Order received: 3
== APP == Order received: 4
...
```

服务消费者:
```shell
You're up and running! Both Dapr and your app logs will appear here.

== APP == Order passed: 1
== APP == Order passed: 2
== APP == Order passed: 3
== APP == Order passed: 4
...
```

可以看到,服务调用正常执行.

来看一下消费者的代码,非常简单,就一个 application 类,这里只展示关键部分内容:

```java
...
private static final String DAPR_HTTP_PORT = System.getenv().getOrDefault("DAPR_HTTP_PORT", "3500");

public static void main(String[] args) throws InterruptedException, IOException {
		String dapr_url = "http://localhost:" + DAPR_HTTP_PORT + "/orders";
		for (int i=1; i<=20; i++) {
			int orderId = i;
			JSONObject obj = new JSONObject();
			obj.put("orderId", orderId);

			HttpRequest request = HttpRequest.newBuilder()
					.POST(HttpRequest.BodyPublishers.ofString(obj.toString()))
					.uri(URI.create(dapr_url))
					.header("Content-Type", "application/json")
					.header("dapr-app-id", "order-processor")
					.build();
...
```

通过查看消费者代码可以知道,消费者调用的地址是 localhost:{DAPR_PORT}/orders,并且在请求中携带了为 dapr-app-id=order-processor 的 header.

消费者直接从 Dapr 调用服务，不再具体关心服务提供者的地址是什么,由 Dapr 去通过 dapr-app-id 找到 order-processor 服务.

如果将这个场景换成在非 Dapr 的情况下,那么在消费者端必须知道服务提供者的地址,例如 http://{service}/orders,如果服务提供者有多个实例,那么还需要填写多个地址.

调用的链路如下:

Consumer--->Consumer Dapr--->Service Dapr---> Service

同时可以注意到,这是使用 HTTP 的方式从 Dapr 调用服务,就像平时在 Java 代码中调用其他服务一样,而另一种方式是使用 Dapr 的 SDK 使用 GRPC 调用服务.



# 注意

本文还在持续创作中

TODO Dapr 流量控制