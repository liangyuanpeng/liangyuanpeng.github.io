---
layout:     post 
slug:      "kubernetes-hpa-custom-metrics-for-effective-cpu-memory-scaling"
title:      "Kubernetes HPA:定制指标实现有效的CPU和内存扩展"
subtitle:   ""
description: ""
date:       2023-03-24
author:     "梁远鹏"
image: "https://res.cloudinary.com/lyp/image/upload/v1635353670/hugo/banner/pexels-helena-lopes-2253275.jpg"
published: true
tags:
    - kubernetes 
    - cncf
    - k8s
    - kind
    - 翻译
categories: [ kubernetes ]
---

介绍和概述：

Kubernetes已成为容器编排的事实标准，为管理大规模容器化应用程序提供了强大的平台。 Kubernetes的一个基本功能是其自动缩放功能，它允许应用程序根据工作负载和性能指标进行扩展或缩减。在本文中，我们将探讨Horizontal Pod Autoscaler（HPA），这是Kubernetes自动缩放的关键组件。我们将深入了解HPA的基础知识、工作原理以及如何使用自定义指标和资源限制来增强其性能。通过本文的学习，您将对HPA有一个扎实的理解，并知道如何配置它以优化您的Kubernetes部署。

Kubernetes中的自动缩放：

自动缩放是现代容器编排系统的一个关键功能，使应用程序能够根据需求和性能指标自动调整其资源。这种动态缩放允许系统保持最佳的性能和效率，同时最小化运营成本。

在Kubernetes中，自动缩放可以在不同的级别实现：

集群自动缩放：该组件通过根据资源利用率和需求添加或删除集群中的节点来扩展整个Kubernetes集群。
Horizontal Pod Autoscaler（HPA）：HPA根据预定义的性能指标（如CPU利用率、内存使用情况或自定义指标）调整特定部署或有状态集的副本数量。
Vertical Pod Autoscaler（VPA）：VPA根据历史使用模式和当前资源需求自动调整Pod中各个容器的CPU和内存请求和限制。
自动缩放的重要性：

自动缩放提供了许多维护高效和弹性系统的优势，包括：

资源优化：自动缩放确保您的应用程序使用正确的资源量来满足其性能要求，减少了过度提供或欠提供的风险。
成本效益：通过根据工作负载自动调整资源，您可以最小化基础设施成本，因为您只支付实际需要的资源。
提高可靠性：自动缩放通过在高需求时进行扩展和在需求减少时进行缩减，以维护应用程序的可用性和性能，从而防止潜在的瓶颈或系统故障。
提高用户体验：通过确保您的应用程序具有处理不同工作负载所需的必要资源，自动缩放可以通过减少延迟和保持一致的性能来提高整体用户体验。



Kubernetes中的水平Pod自动缩放器（HPA）
Kubernetes中水平Pod自动缩放器（HPA）的基本工作机制包括监控、缩放策略和Kubernetes度量服务器。让我们分解每个组件：

监控
HPA持续监视Kubernetes集群中部署的Pod的指标。默认情况下，HPA监视CPU利用率，但也可以配置为监视内存使用情况、自定义指标或其他每个Pod的指标。

对于每个Pod的资源指标（例如CPU），HPA从每个目标Pod的资源指标API获取指标。基于目标利用率或原始值，控制器从所有目标Pod的这些值的平均值计算缩放比率。如果某些容器缺少相关资源请求，则CPU利用率将未被定义，该指标不会发生自动缩放。

对于每个Pod的自定义指标，控制器的操作方式类似，但使用原始值而不是利用率值。

对于对象和外部指标，HPA获取描述对象的单个指标，将其与目标值进行比较，并生成缩放比率。在自动缩放/v2 API版本中，在比较之前可以将该值除以Pod数。

这些指标由Kubernetes Metrics服务器收集和报告，它从每个节点上运行的kubelet汇总资源使用数据。

缩放策略:
在配置HPA时，您需要定义缩放策略来确定自动缩放器如何响应指标的变化。这些策略包括:

目标指标值: 这是您希望HPA维护的指标的期望值。例如，您可能会设置50％的目标CPU利用率，以确保您的Pod既不会过度负担也不会被浪费。
最小和最大副本数: 这些值定义了HPA可以将您的部署缩放到的最小和最大副本数。这可以防止过度缩放，从而可能导致负载过重或消耗过多的资源。

缩放决策:
HPA使用收集的指标和定义的缩放策略来做出缩放决策。如果监视的指标超过目标值，HPA将增加部署或状态集的副本数以更均匀地分配负载。相反，如果指标低于目标值，HPA将减少副本数以节省资源。

Kubernetes Metrics Server:
Kubernetes Metrics Server是资源使用数据的集群聚合器。它从每个节点上的kubelet收集数据，并向需要资源使用信息的HPA和其他组件提供指标。Metrics Server是启用Kubernetes中实时指标和其他依赖于指标的功能的关键组件。

总之，在Kubernetes中，Horizontal Pod Autoscaler通过持续监视Pod指标，应用基于目标值和副本限制的缩放策略，做出缩放决策以维持最佳资源利用率。 Kubernetes Metrics Server在为HPA提供必要数据以做出明智的决策方面发挥着关键作用。

HPA中的自定义指标

自定义指标是用户定义的性能指标，它们扩展了Kubernetes中水平Pod自动缩放器(HPA)支持的默认资源指标（例如CPU和内存）。默认情况下，HPA基于Pod资源请求进行缩放决策，这代表Pod运行所需的最低资源。然而，这种方法可能不利于实现最佳性能。相反，基于资源限制进行缩放通常更有益，因为这可以确保应用程序不会达到其最大资源限制。自定义指标可以实现更精细和应用程序特定的自动缩放决策，从而提高资源利用率和系统性能。

为什么需要自定义指标：

虽然Kubernetes提供的默认指标，例如基于资源请求的CPU和内存使用情况，在许多情况下非常有用，但它们可能不足以满足所有应用程序的需求。基于资源限制进行缩放可以确保应用程序可以处理各种工作负载，而不会达到其允许的最大资源。自定义指标允许您根据应用程序的特定需求定制HPA的缩放行为，从而实现更精确和高效的自动缩放。

在HPA中使用自定义指标：

要在HPA中使用自定义指标，您需要：

确保您的集群设置支持自定义指标。这通常涉及部署自定义指标API服务器并配置必要的监视工具，如Prometheus。

如果需要，在您的应用程序代码中定义自定义指标，并通过适当的端点公开它们。

通过在HPA清单中指定自定义指标来配置HPA使用它们。

自定义指标及其用例的示例：

1.请求速率：对于那些入站请求数量对资源消耗有显著影响的应用程序，您可以基于请求速率定义自定义指标。这使得HPA可以根据实际工作负载而不仅仅是CPU或内存使用情况来缩放副本数量。

用例：需要处理不同入站流量级别的API网关。

2.队列长度：对于从队列中处理任务的应用程序，您可以创建基于队列长度的自定义指标。这使得HPA可以根据任务积压量来缩放应用程序，以确保处理能力与工作负载相匹配。

用例：消费来自消息队列的后台作业处理服务。

#  原文地址

https://medium.com/@caiolombello/kubernetes-hpa-custom-metrics-for-effective-cpu-memory-scaling-23526bba9b4