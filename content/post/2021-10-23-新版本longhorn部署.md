---
layout:     post 
slug:      "deploy-new-longhorn-lank8s.cn"
title:      "新版本longhorn部署需要k8s.gcr.io镜像"
subtitle:   ""
description: "在之前，longhorn的部署是不涉及k8s.gcr.io的镜像的,但是在现在新版本当中,csi相关的镜像都是直接使用k8s.gcr.io中的镜像."
date:       2021-10-23
author:     "梁远鹏"
image: "img/post-bg-2015.jpg"
published: true
tags:
    - longhorn 
    - cncf
categories: [ CloudNative ]
---

# 前言  

在之前，longhorn的部署是不涉及k8s.gcr.io的镜像的,但是在现在新版本当中,csi相关的镜像都是直接使用k8s.gcr.io中的镜像.

# 淡定  

不要慌,这时候可以使用短域名镜像代理lank8s.cn来代替k8s.gcr.io.只需要将k8s.gcr.io修改为lank8s.cn就可以了，其他都不变.

# 部署

按照[官网文档](https://longhorn.io/docs/1.2.2/deploy/install/install-with-helm/)一步一步做,走起. 

```shell
1. helm repo add longhorn https://charts.longhorn.io
2. helm repo update
3. kubectl create namespace longhorn-system 
4. helm install longhorn longhorn/longhorn --namespace longhorn-system  
```

现在已经通过helm chart部署起来了，等待一会看看情况，不出意外的话会因为拉取镜像部署失败.  

```shell
[root@smartwc01 ~]#  kubectl get pod -n longhorn-system
NAME                                        READY   STATUS              RESTARTS   AGE
csi-attacher-75588bff58-qrbfg               0/1     ImagePullBackOff    0          4m46s
csi-attacher-75588bff58-r77n8               0/1     ImagePullBackOff    0          4m46s
csi-attacher-75588bff58-t944p               0/1     ImagePullBackOff    0          4m46s
csi-provisioner-669c8cc698-2p22g            0/1     ImagePullBackOff    0          4m46s
csi-provisioner-669c8cc698-d6md5            0/1     ErrImagePull        0          4m46s
csi-provisioner-669c8cc698-ppktl            0/1     ImagePullBackOff    0          4m46s
csi-resizer-5c88bfd4cf-d822s                0/1     ContainerCreating   0          4m46s
csi-resizer-5c88bfd4cf-j9n27                0/1     ContainerCreating   0          4m46s
csi-resizer-5c88bfd4cf-sl92r                0/1     ContainerCreating   0          4m46s
csi-snapshotter-69f8bc8dcf-9rf7c            0/1     ContainerCreating   0          4m45s
csi-snapshotter-69f8bc8dcf-pnrt8            0/1     ContainerCreating   0          4m45s
csi-snapshotter-69f8bc8dcf-sssnb            0/1     ContainerCreating   0          4m45s
engine-image-ei-d4c780c6-9525q              1/1     Running             0          4m55s
instance-manager-e-a39ce34c                 1/1     Running             0          4m55s
instance-manager-r-71c5e3f3                 1/1     Running             0          4m54s
longhorn-csi-plugin-8s25k                   0/2     ContainerCreating   0          4m45s
longhorn-driver-deployer-75f68555c9-mhb8j   1/1     Running             0          5m24s
longhorn-manager-6dbsn                      1/1     Running             0          5m10s
longhorn-ui-75ccbd4695-92cj2                1/1     Running             0          5m24s
```

果然失败了，describe一下看看原因: 
```shell
[root@smartwc01 ~]# k describe po -n longhorn-system csi-attacher-75588bff58-qrbfg
...
  Warning  Failed     36s                 kubelet            Error: ErrImagePull
  Normal   BackOff    36s                 kubelet            Back-off pulling image "k8s.gcr.io/sig-storage/csi-attacher:v3.2.1"
  Warning  Failed     36s                 kubelet            Error: ImagePullBackOff
  Normal   Pulling    24s (x2 over 5m2s)  kubelet            Pulling image "k8s.gcr.io/sig-storage/csi-attacher:v3.2.1"
```

可以看到,pod从k8s.gcr.io拉取镜像失败了,这时候只需要可以helm upgrade一下将k8s.gcr.io都修改为lank8s.cn就可以了.


```shell
[root@smartwc01 ~]# kubectl get pod -n longhorn-system
NAME                                        READY   STATUS    RESTARTS   AGE
csi-attacher-6d74f5876-s65lf                1/1     Running   0          31s
csi-provisioner-dc6b54764-b75rr             1/1     Running   0          30s
csi-resizer-6779c54465-n97l5                1/1     Running   0          30s
csi-snapshotter-8ccc478c7-4xmcv             1/1     Running   0          29s
engine-image-ei-d4c780c6-2z2zk              1/1     Running   0          39s
instance-manager-e-f73ec881                 1/1     Running   0          39s
instance-manager-r-2c992aca                 1/1     Running   0          39s
longhorn-csi-plugin-6l9xh                   2/2     Running   0          29s
longhorn-driver-deployer-78964dfc64-pvl78   1/1     Running   0          62s
longhorn-manager-ctfqx                      1/1     Running   0          62s
longhorn-ui-75ccbd4695-tm85k                1/1     Running   0          62s
```
```

TODO 更新helm upgrade命令,
TODO 添加helm install scaleCount=1且镜像为lank8s.cn的命令


