---
layout:     post 
slug:      "kuberne-kep-1880-Multiple-Service-CIDRs"
title:      "kuberne-kep-1880-多服务CIDR"
subtitle:   ""
description: ""
date:       2023-12-27
author:     "梁远鹏"
image: "/img/banner-pexels.jpg"
published: true
wipnote: true
tags:
    - k8s
    - kubernetes
    - cncf
    - golang
    - kep
categories: 
    - kubernetes
---

# KEP-1880 多服务 CIDR 是什么

[KEP-1880](https://github.com/kubernetes/enhancements/tree/master/keps/sig-network/1880-multiple-service-cidrs#summary) 允许通过 API 对象配置分配给 Kubernetes 集群的 ServiceCIDR,能够动态的扩展 kubernetes 集群的服务的 IP.

# Proposal

这个提议实现了一个新的IP分配器逻辑,其中主要使用了两个 API 对象,ServiceCIDR 和 IPAddress,并且允许用户可以通过创建一个新的 ServiceCIDR 来达到动态增加可用 service IP 的效果.

这个分配器可以"自动"的使用任何可用的 ServiceCIDR 中的IP,kubernetes 社区考虑添加这种模型,就像给存储系统添加更多的磁盘以增加可用的磁盘空间一样.

为了简化 API 模型以及使其可以向后兼容,并且避免它演变成不同的东西并且与其他的API(例如 Gateway API)发生冲突,这个提议添加了以下约束:

- ServiceCIDR 在创建之后是不可变的
- 只有当 ServiceCIDR 没有被任何 service IP 引用时才能够删除 ServiceCIDR 对象
- 可能存在重叠的 ServiceCIDR
- apiserver 会定期的确保存在一个默认的ServiceCIDR
- 集群中存在的任何 IP 地址都必须属于 ServiceCIDR 定义的 service CIDR 内
- 任何配合了 ClusterIP 的服务都应该有一个关联的 IPAddress 对象
- 处于正在删除状态的 ServiceCIDR 不能分配新的 IP

这样的话 Service 和 IPAddress 之间就是一个 1:1 的关系,以及 IPAddress 与对应的 ServiceCIDR 是 N:1 的关系.有一个值得关注的是重叠的 ServiceCIDR 会合并在内存中, IPAddress 不是存在一个特定的 ServiceCIDR 对象,而是包含了这个 IP 段的任何 ServiceCIDR.(也就是说多个 ServiceCIDR 可以分配相同的 IP 段)

新的分配器逻辑还可以被其他 API 使用,例如 Gateway API.

# 演示

接下来会使用 Kind 来创建一个 kubernetes 来演示多服务 CIDR 的效果.

## 用例

### IP耗尽

### 给 kubernetes 集群的 service 切换一个新的 IP 段
