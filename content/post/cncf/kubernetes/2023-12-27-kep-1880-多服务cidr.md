---
layout:     post 
slug:      "kuberne-kep-1880-Multiple-Service-CIDRs"
title:      "kuberne-kep-1880-å¤šæœåŠ¡CIDR"
subtitle:   ""
description: ""
date:       2023-12-27
author:     "æ¢è¿œé¹"
image: "/img/banner-pexels.jpg"
published: true
tags:
    - k8s
    - kubernetes
    - cncf
    - golang
    - kep
categories: 
    - kubernetes
---

# KEP-1880 å¤šæœåŠ¡ CIDR æ˜¯ä»€ä¹ˆ

[KEP-1880](https://github.com/kubernetes/enhancements/tree/master/keps/sig-network/1880-multiple-service-cidrs#summary) å…è®¸é€šè¿‡ API å¯¹è±¡é…ç½®åˆ†é…ç»™ Kubernetes é›†ç¾¤çš„ ServiceCIDR,èƒ½å¤ŸåŠ¨æ€çš„æ‰©å±• kubernetes é›†ç¾¤çš„æœåŠ¡çš„ IP.

# Proposal

è¿™ä¸ªæè®®å®ç°äº†ä¸€ä¸ªæ–°çš„IPåˆ†é…å™¨é€»è¾‘,å…¶ä¸­ä¸»è¦ä½¿ç”¨äº†ä¸¤ä¸ª API å¯¹è±¡,ServiceCIDR å’Œ IPAddress,å¹¶ä¸”å…è®¸ç”¨æˆ·å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°çš„ ServiceCIDR æ¥è¾¾åˆ°åŠ¨æ€å¢åŠ å¯ç”¨ service IP çš„æ•ˆæœ.

è¿™ä¸ªåˆ†é…å™¨å¯ä»¥"è‡ªåŠ¨"çš„ä½¿ç”¨ä»»ä½•å¯ç”¨çš„ ServiceCIDR ä¸­çš„ IP,kubernetes ç¤¾åŒºè€ƒè™‘æ·»åŠ è¿™ç§æ¨¡å‹,å°±åƒç»™å­˜å‚¨ç³»ç»Ÿæ·»åŠ æ›´å¤šçš„ç£ç›˜ä»¥å¢åŠ å¯ç”¨çš„ç£ç›˜ç©ºé—´ä¸€æ ·.

ä¸ºäº†ç®€åŒ– API æ¨¡å‹ä»¥åŠä½¿å…¶å¯ä»¥å‘åå…¼å®¹,å¹¶ä¸”é¿å…å®ƒæ¼”å˜æˆä¸åŒçš„ä¸œè¥¿å¹¶ä¸”ä¸å…¶ä»–çš„ API(ä¾‹å¦‚ Gateway API)å‘ç”Ÿå†²çª,è¿™ä¸ªæè®®æ·»åŠ äº†ä»¥ä¸‹çº¦æŸ:

- ServiceCIDR åœ¨åˆ›å»ºä¹‹åæ˜¯ä¸å¯å˜çš„
- åªæœ‰å½“ ServiceCIDR æ²¡æœ‰è¢«ä»»ä½• service IP å¼•ç”¨æ—¶æ‰èƒ½å¤Ÿåˆ é™¤ ServiceCIDR å¯¹è±¡
- å¯èƒ½å­˜åœ¨é‡å çš„ ServiceCIDR
- apiserver ä¼šå®šæœŸçš„ç¡®ä¿å­˜åœ¨ä¸€ä¸ªé»˜è®¤çš„ServiceCIDR
- é›†ç¾¤ä¸­å­˜åœ¨çš„ä»»ä½• IP åœ°å€éƒ½å¿…é¡»å±äº ServiceCIDR å®šä¹‰çš„ service CIDR å†…
- ä»»ä½•é…åˆäº† ClusterIP çš„æœåŠ¡éƒ½åº”è¯¥æœ‰ä¸€ä¸ªå…³è”çš„ IPAddress å¯¹è±¡
- å¤„äºæ­£åœ¨åˆ é™¤çŠ¶æ€çš„ ServiceCIDR ä¸èƒ½åˆ†é…æ–°çš„ IP

è¿™æ ·çš„è¯ Service å’Œ IPAddress ä¹‹é—´å°±æ˜¯ä¸€ä¸ª 1:1 çš„å…³ç³»,ä»¥åŠ IPAddress ä¸å¯¹åº”çš„ ServiceCIDR æ˜¯ N:1 çš„å…³ç³».æœ‰ä¸€ä¸ªå€¼å¾—å…³æ³¨çš„æ˜¯é‡å çš„ ServiceCIDR ä¼šåˆå¹¶åœ¨å†…å­˜ä¸­, IPAddress ä¸æ˜¯å­˜åœ¨ä¸€ä¸ªç‰¹å®šçš„ ServiceCIDR å¯¹è±¡,è€Œæ˜¯åŒ…å«äº†è¿™ä¸ª IP æ®µçš„ä»»ä½• ServiceCIDR.(ä¹Ÿå°±æ˜¯è¯´å¤šä¸ª ServiceCIDR å¯ä»¥åˆ†é…ç›¸åŒçš„ IP æ®µ)

æ–°çš„åˆ†é…å™¨é€»è¾‘è¿˜å¯ä»¥è¢«å…¶ä»– API ä½¿ç”¨,ä¾‹å¦‚ Gateway API.

# æ¼”ç¤º

æ¥ä¸‹æ¥ä¼šä½¿ç”¨ Kind æ¥åˆ›å»ºä¸€ä¸ª kubernetes æ¥æ¼”ç¤ºå¤šæœåŠ¡ CIDR çš„æ•ˆæœ.

## å‡†å¤‡ kubernetes é›†ç¾¤

å‡†å¤‡å¥½ä¸€ä¸ª kubernetes é›†ç¾¤,è¿™é‡Œä½¿ç”¨ Kind å¿«é€Ÿéƒ¨ç½²ä¸€ä¸ª kubernetes.

kind.yaml
```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
networking:
  ipFamily: ipv4
  kubeProxyMode: iptables
  serviceSubnet: "10.96.0.0/28"
  dnsSearch: []
nodes:
- role: control-plane
  image: kindest/node:v1.29.0@sha256:eaa1450915475849a73a9227b8f201df25e55e268e5d619312131292e324d570
  extraPortMappings:
  - containerPort: 32080
    hostPort: 32080
    listenAddress: "0.0.0.0"
- role: worker
  image: kindest/node:v1.29.0@sha256:eaa1450915475849a73a9227b8f201df25e55e268e5d619312131292e324d570
- role: worker
  image: kindest/node:v1.29.0@sha256:eaa1450915475849a73a9227b8f201df25e55e268e5d619312131292e324d570
featureGates: {"AllAlpha":true}
runtimeConfig: {"api/alpha":"true"}
kubeadmConfigPatches:
- |
  kind: ClusterConfiguration
  metadata:
    name: config
  apiServer:
    extraArgs:
      "v": "4"
  controllerManager:
    extraArgs:
      "v": "4"
  scheduler:
    extraArgs:
      "v": "4"
  ---
  kind: InitConfiguration
  nodeRegistration:
    kubeletExtraArgs:
      "v": "4"
  ---
  kind: JoinConfiguration
  nodeRegistration:
    kubeletExtraArgs:
      "v": "4"
```

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä½¿ç”¨ä¸Šè¿°çš„ Kind é…ç½®æ–‡ä»¶åˆ›å»ºä¸€ä¸ª 1 master 2 node çš„ kubernetes é›†ç¾¤:
```shell
kind create cluster --config kind.yaml -v9 --name servicecidr  
```

ç­‰å¾…ä¸€ä¼šå‡ºç°ä»¥ä¸‹æç¤ºåˆ™è¡¨ç¤ºå‘½ä»¤æ‰§è¡ŒæˆåŠŸäº†:
```shell
...
I1228 14:39:34.531417     139 round_trippers.go:553] PATCH https://servicecidr-control-plane:6443/api/v1/nodes/servicecidr-worker2?timeout=10s 200 OK in 3 milliseconds

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
 âœ“ Joining worker nodes ğŸšœ
Set kubectl context to "kind-servicecidr"
You can now use your cluster with:

kubectl cluster-info --context kind-servicecidr

Not sure what to do next? ğŸ˜…  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
```

## è§‚å¯Ÿé»˜è®¤æƒ…å†µçš„ä¸€äº›æ•°æ®

kubernetes é›†ç¾¤å‡†å¤‡å¥½åå¯ä»¥è§‚å¯Ÿä¸€ä¸‹é»˜è®¤æƒ…å†µ kubernetes çš„ä¸€äº›å…³äº ServiceCIDR çš„èµ„æºå¯¹è±¡æƒ…å†µ.

1. æœ‰ä¸€ä¸ªåä¸º kubernetes çš„é»˜è®¤ ServiceCIDR å¯¹è±¡,æ ¹æ®ä¸Šé¢ Kind é…ç½®æ–‡ä»¶ä¸­çš„ `serviceSubnet` æ¥åˆ›å»ºçš„.

```shell
lank8s@lank8s:~/cidrs$ kubectl get servicecidrs
NAME         CIDRS          AGE
kubernetes   10.96.0.0/28   3m57s
```

2. æœ‰ä¸€ä¸ªåä¸º kubernetes çš„é»˜è®¤ service å¯¹è±¡,æ˜¯é»˜è®¤ ServiceCIDR å¯¹è±¡åˆ†é…çš„ç¬¬ä¸€ä¸ª IP.

```shell
lank8s@lank8s:~/cidrs$ kubectl get service
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   5m7s
```

3. é»˜è®¤ Service ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ IPAddress å¯¹è±¡

```shell
lank8s@lank8s:~/cidrs$ kubectl get ipaddress
NAME         PARENTREF
10.96.0.1    services/default/kubernetes
10.96.0.10   services/kube-system/kube-dns
```

å¯ä»¥çœ‹åˆ°å®é™…ä¸Šä¼šæœ‰ä¸¤ä¸ª IPAddress,å¦ä¸€ä¸ªæ˜¯ç”± coreDNS äº§ç”Ÿçš„.

ServiceCIDR ä½¿ç”¨ finalizers æœºåˆ¶æ¥ä¿è¯èµ„æºçš„è”çº§åˆ é™¤,åªæœ‰å½“å¦ä¸€ä¸ª ServiceCIDR åŒ…å«äº†å¯¹åº”çš„ IP æ®µæˆ–è€…æ˜¯æ²¡æœ‰ç›¸å…³çš„ IP æ®µæ—¶ ServiceCIDR æ‰ä¼šè¢«åˆ é™¤.

## ç”¨ä¾‹

### IPè€—å°½

åœ¨æŸäº›æƒ…å†µä¸‹, ServiceCIDR IP æ®µè¢«è€—å°½äº†,è¿™æ—¶å€™æƒ³è¦å¢åŠ  service çš„è¯æ˜¯ä¸€ç§ç ´åæ€§çš„æ“ä½œ,ç”šè‡³å¯èƒ½ä¼šé€ æˆæ•°æ®ä¸¢å¤±. è€Œå½“æœ‰äº† Multiple-Service-CIDRs ä¹‹å,åªéœ€è¦æ–°å¢ä¸€ä¸ª ServiceCIDR å¯¹è±¡å°±å¯ä»¥å®Œæˆè¿™ä¸ªæ“ä½œäº†.

æ¥ä¸‹æ¥ç®€å•æ¼”ç¤ºä¸€ä¸‹,é¦–å…ˆéå†åˆ›å»º service,æŠŠé›†ç¾¤çš„ service IP éƒ½è€—å°½:

```shell
lank8s@lank8s:~/cidrs$ for i in $(seq 1 13); do kubectl create service clusterip "test-$i" --tcp 80 -o json | jq -r .spec.clusterIP; done
10.96.0.14
10.96.0.12
10.96.0.11
10.96.0.9
10.96.0.13
10.96.0.5
10.96.0.8
10.96.0.7
10.96.0.2
10.96.0.3
10.96.0.4
10.96.0.6
error: failed to create ClusterIP service: Internal error occurred: failed to allocate a serviceIP: range is full
```

å¯ä»¥çœ‹åˆ°æœ€åæç¤ºæ— æ³•åˆ›å»ºæ–°çš„ Service äº†,è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª ServiceCIDR å¯¹è±¡:

cidr.yaml
```yaml
apiVersion: networking.k8s.io/v1alpha1
kind: ServiceCIDR
metadata:
  name: newcidr1
spec:
  cidrs: 
  - 192.96.0.0/24
```

```shell
lank8s@lank8s:~/cidrs$ kubectl apply -f cidrs.yaml 
servicecidr.networking.k8s.io/newcidr1 created
```

ç„¶åç»§ç»­åˆ›å»ºæ–°çš„ Service çœ‹çœ‹ç»“æœå¦‚ä½•:

```shell
lank8s@lank8s:~/cidrs$ for i in $(seq 13 16); do kubectl create service clusterip "test-$i" --tcp 80 -o json | jq -r .spec.clusterIP; done
192.96.0.43
192.96.0.172
192.96.0.146
192.96.0.112
```

å¯ä»¥çœ‹åˆ°è¿™æ—¶å€™å·²ç»å¯ä»¥ç»§ç»­åˆ›å»º Service äº†,å¹¶ä¸”æ–°çš„ Service å¯¹åº”çš„ IP éƒ½æ˜¯å’Œåˆšåˆ›å»ºçš„ ServiceCIDR èµ„æºæ‰€é…ç½®çš„ç½‘æ®µé‡Œé¢.

æ¥ä¸‹æ¥è¯•ç€åˆ é™¤ä¸€ä¸‹è¿™ä¸ª ServiceCIDR å¯¹è±¡:

```shell
lank8s@lank8s:~/cidrs$ kubectl delete serviceCIDR newcidr1
servicecidr.networking.k8s.io "newcidr1" deleted

```

ç”±äºé›†ç¾¤ä¸­æœ‰å…³è”çš„ service,æ‰€ä»¥ä¼šæ— æ³•åˆ é™¤è¿™ä¸ª ServiceCIDR,çœ‹ä¸€ä¸‹è¿™ä¸ªæ—¶å€™ ServiceCIDR å¯¹è±¡çš„çŠ¶æ€:

```shell
lank8s@lank8s:~/cidrs$  kubectl get servicecidr newcidr1 -o yaml
apiVersion: networking.k8s.io/v1alpha1
kind: ServiceCIDR
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"networking.k8s.io/v1alpha1","kind":"ServiceCIDR","metadata":{"annotations":{},"name":"newcidr1"},"spec":{"cidrs":["192.96.0.0/24"]}}
  creationTimestamp: "2023-12-28T14:53:28Z"
  deletionGracePeriodSeconds: 0
  deletionTimestamp: "2023-12-28T14:55:36Z"
  finalizers:
  - networking.k8s.io/service-cidr-finalizer
  name: newcidr1
  resourceVersion: "2363"
  uid: 38496a54-f718-470f-935f-f6db63873869
spec:
  cidrs:
  - 192.96.0.0/24
status:
  conditions:
  - lastTransitionTime: "2023-12-28T14:55:36Z"
    message: There are still IPAddresses referencing the ServiceCIDR, please remove
      them or create a new ServiceCIDR
    reason: Terminating
    status: "False"
    type: Ready
```

å¯ä»¥çœ‹åˆ°è¿™æ—¶å€™å®ƒçš„ status æ˜¯ false,finalizers æ ‡å¿—ä¸Šæœ‰ `networking.k8s.io/service-cidr-finalizer` æ‰€ä»¥æ— æ³•åˆ é™¤.

ç°åœ¨æˆ‘ä»¬å°†å¯¹åº”çš„ service éƒ½åˆ æ‰:

```shell
lank8s@lank8s:~/cidrs$ for i in $(seq 13 16); do kubectl delete service "test-$i" ; done
service "test-13" deleted
service "test-14" deleted
service "test-15" deleted
service "test-16" deleted
```

è¿™ä¸ªæ—¶å€™å†æŸ¥è¯¢ä¸€ä¸‹åˆšæ‰çš„ ServiceCIDR:
```shell
lank8s@lank8s:~/cidrs$  kubectl get servicecidr newcidr1
Error from server (NotFound): servicecidrs.networking.k8s.io "newcidr1" not found
```

å¯ä»¥çœ‹åˆ°è¿™ä¸ª ServiceCIDR å·²ç»ä¸å­˜åœ¨äº†,å› ä¸ºæ²¡æœ‰ä¸å…¶å…³è”çš„ service æ‰€ä»¥å®ƒè¢«æˆåŠŸåˆ é™¤äº†.

### ç»™ kubernetes é›†ç¾¤çš„ service åˆ‡æ¢ä¸€ä¸ªæ–°çš„ IP æ®µ

å¦ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯å½“ç”¨æˆ·æƒ³è¦å°†é›†ç¾¤ä¸­ç°æœ‰çš„ service IP éƒ½åˆ‡æ¢åˆ°ä¸€ä¸ªæ–°çš„ IP æ®µ,ä¾‹å¦‚æƒ³è¦å°† `10.96.0.0/28` åˆ‡æ¢åˆ° `192.168.7.0/24`.

æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä»¥ä¸‹çš„æ­¥éª¤æ“ä½œ:

1. ä½¿ç”¨ `192.168.7.0/24` ä¸´æ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„ ServiceCIDR å¯¹è±¡
2. åˆ é™¤é»˜è®¤çš„ ServiceCIDR,è®©å®ƒå¤„äºä¸€ä¸ªè¢«åˆ é™¤çš„çŠ¶æ€,è¿™æ ·æœ‰æ–°çš„ service åˆ›å»ºæ—¶å°±ä¸ä¼šä½¿ç”¨è¿™ä¸ª ServiceCIDR åˆ†é…æ–°çš„ IP åœ°å€äº†
3. è¿™ä¸ªæ—¶å€™åªæœ‰é»˜è®¤çš„ kubernetes.default service æ˜¯ä¸€å®šè¦åœ¨é»˜è®¤çš„ ServiceCIDR é‡Œé¢çš„
4. é‡æ–°åˆ›å»ºé›†ç¾¤å†…çš„å…¶ä»–æ‰€æœ‰ service,è®©å®ƒä»¬å¯ä»¥ä»æ–°çš„ ServiceCIDR åˆ†é… IP åœ°å€
5. è¿™ä¸ªæ—¶å€™å¯ä»¥å¯åŠ¨ä¸€ä¸ªæ–°çš„ apiserver,ç„¶åæŒ‡å®šå®ƒçš„ serviceSubnet ä¸æ–°åˆ›å»ºçš„ ServiceCIDR ç½‘æ®µç›¸åŒ¹é…,åœ¨è¿™ä¸ªç¤ºä¾‹çš„è¯å°±æ˜¯ `192.168.7.0/24` 
6. å½“æ–°çš„ apiserver æˆåŠŸå¯åŠ¨åå¯ä»¥å…³é—­å°±çš„ apiserver äº†
7. åˆ é™¤é»˜è®¤çš„ kubernetes.default æœåŠ¡,è¿™æ ·å°±å¯ä»¥è®©é›†ç¾¤å†…åŸæœ‰çš„ ServiceCIDR è¢«åˆ é™¤äº†,ç„¶åé»˜è®¤çš„ kubernetes.default æœåŠ¡ä¼šç”±æ–°çš„ apiserver åˆ›å»ºå‡ºæ¥,å¹¶ä¸” IP ç½‘æ®µæ˜¯ç”±æ–°çš„ ServiceCIDR åˆ†é…çš„.
8. è¿™ä¸ªæ—¶å€™å¯ä»¥åˆ é™¤åˆšæ‰ä¸´æ—¶åˆ›å»ºçš„ ServiceCIDR äº†ï¼Œå› ä¸ºæ–°å¯åŠ¨çš„ apiserver å·²ç»æŒ‡å®šäº† serviceSubnet ä¸è¿™ä¸ª ServiceCIDR æ˜¯åŒä¸€ä¸ªç½‘æ®µ,è¿™æ—¶å€™ä¸´æ—¶åˆ›å»ºçš„ ServiceCIDR å·²ç»ä¸éœ€è¦äº†. 


### é›†ç¾¤ IP è¿ç§»

ä¸é›†ç¾¤åˆ‡æ¢ IP ç½‘æ®µæ˜¯ä¸€æ ·çš„.


## æœ€å

å¦‚æœ ServiceCIDR å¤„äºè¢«åˆ é™¤çš„çŠ¶æ€,è¿™æ—¶å€™ç®¡ç†çš„ Service æ˜¯ä¸å—å½±å“çš„,å¯ä»¥ç»§ç»­è®¿é—®.

æ–‡ç« æ¼”ç¤ºéƒ¨åˆ†ç¿»è¯‘äº[2]

å‚è€ƒ:

- [1] https://github.com/kubernetes/enhancements/tree/master/keps/sig-network/1880-multiple-service-cidrs#summary
- [2] https://gist.github.com/aojea/c20eb117bf1c1214f8bba26c495be9c7