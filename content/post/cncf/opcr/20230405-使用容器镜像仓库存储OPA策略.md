---
layout:     post 
slug:      "opci-registry-for-opa-policy"
title:      "使用容器镜像仓库存储OPA策略"
subtitle:   ""
description: ""
date:       2023-04-05
author:     "梁远鹏"
image: "/img/banner/viglomir_minimalistic_picture_of_a_lonely_alien_tower_in_a_alie_4b60a721-9932-41e8-9eb9-35fa1be0ab91.png"
published: true
wipnote: true
tags:
    - cncf
    - opa
    - opcr
    - oras
categories: [ cloudnative ]
---    

# 


```yaml
services:
  ghcr-registry:
    url: https://ghcr.io
    type: oci
    # credentials:
    #   bearer:
    #     scheme: "Bearer"
    #     token: "你的token"

bundles:
  authz:
    service: ghcr-registry
    resource: ghcr.io/liangyuanpeng/policy-hello:1.0.0
    persist: true
    polling:
      min_delay_seconds: 30
      max_delay_seconds: 120
```

注意,OPA 只会去 OCI 镜像仓库下载这三种格式的内容:

```
application/vnd.oci.image.layer.v1.tar+gzip
application/vnd.oci.image.manifest.v1+json
application/vnd.oci.image.config.v1+json
```


.manifest
```json
{
    "roots": ["policies"],
    "metadata": {
      "required_builtins": {
          "builtin1": [
          ],
      }
    }
}
```

data.json
```json
{}
```

policies/hello.rego

```rego
package policies.play

default hello = false

hello {
    m := input.message
    m == "world"
}
```


config.json
```json
{}
```

```shell
opa build src
```

构建好策略后,使用 oras 命令推送到容器镜像仓库,这里使用的是 ghcr.io

```shell
 oras push -u你的账号 -p你的token或密码 ghcr.io/{你的账号}/policy-hello:1.0.0 --config config.json:application/vnd.oci.image.config.v1+json bundle.tar.gz:application/vnd.oci.image.layer.v1.tar+gzip
 ```



 先使用以下命令来尝试看看OPA是否能从OCI registry下载策略并且正常使用其中的内容:
 ```shell
lan@fv-az186-197:~/work/lanactions/lanactions/oparun$ opa run -c configuration.yaml 
{"level":"error","msg":"Failed to load bundle from disk: bundle read failed: archive read failed: EOF","name":"authz","plugin":"bundle","time":"2023-04-05T08:36:14Z"}
{"level":"info","msg":"Starting bundle loader.","name":"authz","plugin":"bundle","time":"2023-04-05T08:36:14Z"}
OPA 0.51.0 (commit 1f52ea1908181bf2ffa4a742f87f4838f1403728, built at 2023-03-31T13:44:46Z)

Run 'help' to see a list of commands and check for updates.

> {"level":"info","msg":"Bundle loaded and activated successfully. Etag updated to 653156df2068ed4c8f6bef67c515883d5331b291f1449160abef39a35163a1cd.","name":"authz","plugin":"bundle","time":"2023-04-05T08:36:14Z"}
> data
{
  "policies": {
    "play": {
      "hello": false
    }
  }
}
 ```

可以看到 OPA 启动后从 OC registry 下载了策略,然后输入`data`可以看到正是上述构建好的策略内容.

现在让我们来尝试一下使用这种方式的情况下能否为数据正常执行策略:

首先退出刚才的程序,我这里使用 Ctrl+D ,然后使用以下命令启动 OPA server:
```
opa run --server --set default_decision=policies -c configuration.yaml
```
 
 这时我们打开另一个窗口来请求数据:

 ```shell
 lan@fv-az186-197:~/work/lanactions/lanactions$ curl localhost:8181 -i -d '{ "message":"world"}' -H 'Content-Type:application/json'
.HTTP/1.1 200 OK
Content-Type: application/json
Date: Wed, 05 Apr 2023 08:40:08 GMT
Content-Length: 24

{"play":{"hello":true}}
lan@fv-az186-197:~/work/lanactions/lanactions$ curl localhost:8181 -i -d '{ "message":"world2"}' -H 'Content-Type:application/json'
HTTP/1.1 200 OK
Content-Type: application/json
Date: Wed, 05 Apr 2023 08:40:14 GMT
Content-Length: 25

{"play":{"hello":false}}
 ```

 可以看到,内容完全符合策略的执行情况: 只有当 `message=world` 时, 策略才会返回 `hello=true`



 # OPCR项目

 可以看到我们在将 OPA 策略推到容器镜像仓库时需要做两步:

 1. 使用 OPA 命令打包策略
 2. 使用 oras 命令推送策略到容器镜像仓库

 而有一个 CNCF sandbox 项目专门为了处理 "OPA 策略镜像",这个项目就是 OPCR.你可以用这个工具就向操作普通容器镜像一样操作 OPA 策略镜像.

 同时 OPCR 还提供了 github action 用于构建和推送 OPA 策略镜像产物.
 

```shell
lan@yunhorn:~/repo/git/liangyuanpeng.github.io/tmp$ opcr templates list

Fetching templates 

  NAME             KIND    DESCRIPTION                    
  github           cicd    GitHub policy CI/CD template.  
  gitlab           cicd    GitLab policy CI/CD template.  
  policy-template  policy  Minimal policy template.       
lan@yunhorn:~/repo/git/liangyuanpeng.github.io/tmp$ opcr templates apply policy-template

Processing template 'policy-template' 

Generating files .

The template 'policy-template' was created successfully.
lan@yunhorn:~/repo/git/liangyuanpeng.github.io/tmp$ tree .
.
├── README.md
└── src
    └── policies
        └── hello-rego.rego

2 directories, 2 files

```


```shell
lan@yunhorn:~/repo/git/liangyuanpeng.github.io/tmp$ opcr  build . -t ghcr.io/liangyuanpeng/policy-hello:1.0.1

Created new image.
digest: sha256:1786513bf6de470983dad0ca37da6d1e9f0301f974586643dd275e00f820818b

Tagging image.
reference: ghcr.io/liangyuanpeng/policy-hello:1.0.1
lan@yunhorn:~/repo/git/liangyuanpeng.github.io/tmp$ opcr  push ghcr.io/liangyuanpeng/policy-hello:1.0.1

Resolved ref [ghcr.io/liangyuanpeng/policy-hello:1.0.1].
digest: sha256:1786513bf6de470983dad0ca37da6d1e9f0301f974586643dd275e00f820818b

Pushed ref [ghcr.io/liangyuanpeng/policy-hello:1.0.1].
digest: sha256:1786513bf6de470983dad0ca37da6d1e9f0301f974586643dd275e00f820818b
```


```shell
lan@yunhorn:~/repo/git/liangyuanpeng.github.io/tmp$ opcr save ghcr.io/liangyuanpeng/policy-hello:1.0.0

Resolved ref [ghcr.io/liangyuanpeng/policy-hello:1.0.0].
digest: sha256:653156df2068ed4c8f6bef67c515883d5331b291f1449160abef39a35163a1cd
lan@yunhorn:~/repo/git/liangyuanpeng.github.io/tmp$ ls
bundle.tar.gz  README.md  src
```