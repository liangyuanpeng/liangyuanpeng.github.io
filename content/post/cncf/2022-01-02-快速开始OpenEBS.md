---
layout:     post 
slug:      "quick-start-openebs"
title:      "快速开始OpenEBS"
subtitle:   ""
description: ""
date:       2021-10-17
author:     "梁远鹏"
image: "[img/post-bg-2015.jpg](https://res.cloudinary.com/lyp/image/upload/v1581729516/hugo/blog.github.io/avian-beak-bird-blur-416117.jpg)"
published: true
tags:
    - openebs 
    - cncf
categories: [ CloudNative ]
---

# 前言  


# 前提  

使用OpenEBS需要机器已经安装了`iSCSI`  

ubuntu可以用下面的命令安装和开启:  

```shell
sudo apt-get update
sudo apt-get install open-iscsi
sudo systemctl enable --now iscsid
```
  
centos系列系统可以用下面的命令安装和开启:  
```shell
yum install iscsi-initiator-utils -y
sudo systemctl enable --now iscsid
```  

# 安装OpenEBS

## Helm方式  

```
helm repo add openebs https://openebs.github.io/charts
helm repo update
helm install openebs --namespace openebs openebs/openebs --create-namespace
```  

上述命令将会安装OpenEBS并且默认安装Jiva和Local PV组件,如果需要其他的存储引擎可以用下面的安装命令开启:   

```
helm install openebs --namespace openebs openebs/openebs --create-namespace --set cstor.enabled=true
```  

等待一会后会出现helm安装成功的提示:   

```shell
oem@lan:~/k8s/openebs$ helm install openebs --namespace openebs openebs/openebs --create-namespace --set cstor.enabled=true

NAME: openebs
LAST DEPLOYED: Mon Jan  3 00:28:41 2022
NAMESPACE: openebs
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
Successfully installed OpenEBS.

Check the status by running: kubectl get pods -n openebs

The default values will install NDM and enable OpenEBS hostpath and device
storage engines along with their default StorageClasses. Use `kubectl get sc`
to see the list of installed OpenEBS StorageClasses.

**Note**: If you are upgrading from the older helm chart that was using cStor
and Jiva (non-csi) volumes, you will have to run the following command to include
the older provisioners:

helm upgrade openebs openebs/openebs \
        --namespace openebs \
        --set legacy.enabled=true \
        --reuse-values

For other engines, you will need to perform a few more additional steps to
enable the engine, configure the engines (e.g. creating pools) and create 
StorageClasses. 

For example, cStor can be enabled using commands like:

helm upgrade openebs openebs/openebs \
        --namespace openebs \
        --set cstor.enabled=true \
        --reuse-values

For more information, 
- view the online documentation at https://openebs.io/ or
- connect with an active community on Kubernetes slack #openebs channel.
```

可以看一下openebs相关的日志运行情况,耐心等待容器运行成功就可以了,第一次需要拉去镜像,所以需要一点时间:   

运行命令`watch kubectl get po -n openebs`  

```
Every 2.0s: kubectl get po -n openebs                                                                                       lan: Mon Jan  3 00:30:41 2022

NAME                                            READY   STATUS              RESTARTS   AGE
openebs-cstor-admission-server-f7c94c6d-n82n6   0/1     ContainerCreating   0          118s
openebs-cstor-csi-controller-0                  0/6     ContainerCreating   0          118s
openebs-cstor-csi-node-hk6kg                    0/2     ContainerCreating   0          118s
openebs-cstor-cspc-operator-d576bb58d-cqcln     0/1     ContainerCreating   0          118s
openebs-cstor-cvc-operator-867b5697b5-glh76     1/1     Running             0          118s
openebs-localpv-provisioner-6f686f7697-967kj    0/1     ContainerCreating   0          118s
openebs-ndm-operator-5948569558-frhjd           0/1     ContainerCreating   0          118s
openebs-ndm-pjfmz                               1/1     Running             0          118s
```  

过了一会可能会出现失败,原因是CSI的镜像的官方地址是`k8s.gcr.io`,国内访问不了,不过没关系,这时候只需要将`k8s.gcr.io`修改为`lank8s.cn`就可以了.  

```shell 
oem@lan:~/repo/git$ helm upgrade openebs --namespace openebs openebs/openebs --create-namespace --set cstor.enabled=true --set csiController.resizer.registry=lank8s.cn --set csiNode.driverRegistrar.image=lank8s.cn 
coalesce.go:200: warning: cannot overwrite table with non table for image (map[pullPolicy:IfNotPresent registry:k8s.gcr.io/ repository:sig-storage/csi-node-driver-registrar tag:v2.3.0])
```   

设置后发现无法生效,目前已经在`slack`给`openebs`提问是否没有开放这个设置.




同时可以运行`kubectl get storageClass`看看storageClass:  


```
NAME                 PROVISIONER          RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
longhorn (default)   driver.longhorn.io   Delete          Immediate              true                   4d3h
openebs-device       openebs.io/local     Delete          WaitForFirstConsumer   false                  3m12s
openebs-hostpath     openebs.io/local     Delete          WaitForFirstConsumer   false                  3m12s
```  

# 试用动态PVC  

当openebs的所有pod都处于Running的时候就已经真正安装OpenEBS成功了,接下来试用一下动态PVC的效果.

# 记录 

完整命令设置命令  

```
helm install openebs --namespace openebs openebs/openebs --create-namespace --set csiController.resizer.registry=lank8s.cn  --set csiController.snapshotter.registry=lank8s.cn  --set csiController.snapshotController.registry=lank8s.cn  --set csiController.attacher.registry=lank8s.cn    --set csiController.provisioner.registry=lank8s.cn  --set csiNode.driverRegistrar.image=lank8s.cn
```

# 注意

本文还在持续编写中
