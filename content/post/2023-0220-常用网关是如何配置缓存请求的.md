---
layout:     post 
slug:   "how-to-config-for-cache-from-gateway"
title:      "常用网关都是如何配置缓存请求的"
subtitle:   ""
description: ""
date:       2023-02-20
author:     "梁远鹏"
image: "https://res.cloudinary.com/lyp/image/upload/v1544363191/hugo/blog.github.io/743a4e9227e1f14cb24a1eb6db29e183.jpg"
published: true
tags:
    - pipy
    - nginx
    - envoy
    - apisix
    - kong
    - pipy
categories: 
    - TECH
---

# 前言 

# Envoy

```yaml
static_resources:
  listeners:
  - address:
      socket_address:
        address: 0.0.0.0
        port_value: 10001
    filter_chains:
    - filters:
        - name: envoy.filters.network.http_connection_manager
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
            scheme_header_transformation:
              scheme_to_overwrite: https
            stat_prefix: ingress_http
            route_config:
              name: local_route
              virtual_hosts:
                - name: local_service
                  domains: ["*"]
                  routes:
                    - match:
                        prefix: "/"
                      response_headers_to_add:
                        - header:
                            key: cache-control
                            value: "max-age=600"
                          append: true
                      route:
                        host_rewrite_literal: proxy.lank8s.cn
                        cluster: proxylank8s
            http_filters:
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
  - address:
      socket_address:
        protocol: TCP
        address: 0.0.0.0
        port_value: 10000
    filter_chains:
      - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              use_remote_address: true
              access_log:
                - name: envoy.file_access_log
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                    path: /dev/stdout
              codec_type: auto
              stat_prefix: ingress_http
              http_filters:
                - name: "envoy.filters.http.cache"
                  typed_config:
                    "@type": "type.googleapis.com/envoy.extensions.filters.http.cache.v3.CacheConfig"
                    typed_config:
                      "@type": "type.googleapis.com/envoy.extensions.http.cache.file_system_http_cache.v3.FileSystemHttpCacheConfig"
                      cache_path: /tmp/envoycache
                      manager_config:
                        thread_pool:
                          thread_count: 1
                - name: envoy.filters.http.router
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
              route_config:
                name: local_route
                virtual_hosts:
                  - name: service
                    domains:
                      - "*"
                    routes:
                      - match:
                          prefix: "/"
                        route:
                          cluster: localproxy
  clusters:
    - name: localproxy
      connect_timeout: 60s
      type: LOGICAL_DNS
      lb_policy: round_robin
      load_assignment:
        cluster_name: localproxy
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 10001
    - name: proxylank8s
      connect_timeout: 60s
      type: LOGICAL_DNS
      lb_policy: round_robin
      load_assignment:
        cluster_name: proxylank8s
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: proxy.lank8s.cn
                      port_value: 443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          sni: proxy.lank8s.cn

admin:
  access_log_path: "/dev/null"
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 8082
```

TODO upstream 替换为 httpbin,使用 docker-compose 搭建环境

首先第一次请求, response header里面可以看到 age,那么就是cache了,

```shell
```

第二次请求,查看响应时间 与第一次请求响应时间对比.

```shell
```

查看缓存目录,已经有内容了.

```shell
```

查看一下缓存的内容,可以看到里面有 header 以及 body 的内容,也就是请求需要返回的东西.

```shell
```

再试试换一个IP地址来访问,但是实际上是同一个资源,这时候会怎么样.

看看缓存目录,多了一个缓存.

```
```

查看一下第二个缓存的内容,可以看到 有个header是带有完整的请求地址的,因此可以得知缓存是根据 域名+path 来作为缓存的唯一key的.
```

```

那么这个缓存的过期是怎么样的呢?我们等一会,直到时间过去了 age 秒. 然后再看一下缓存目录的情况

```shell
```

目前 Envoy 的这个 fifle cache 功能还属于开发中,不是一个稳定的功能,官网文档中已经提示要用一个上游下游都是信任的地方.

# apisix
# Pipy
docker pull flomesh/pipy:0.90.0-54

## pipy的体验

上手门槛比较高，官方文档相对也是比较少的，有一种束手无策的感觉.

例如,官方例子中是的 js 脚本是这样的:  

```shell
pipy()

  .listen(8000)
  .demuxHTTP().to(
    $=>$.muxHTTP().to(
      $=>$.connect('localhost:8080')
    )
  )

```

这是将请求转发到 localhost:8080,而我将地址做了一个修改,将请求修改为转发到`https://registry.lank8s.cn`

```shell
pipy()
  .listen(8000)
  .demuxHTTP().to(
    $=>$.muxHTTP().to(
      $=>$.connect('https://registry.lank8s.cn')
    )
  )
```

PS: `registry.worker.liangyuanpeng.com:443`和`https://registry.lank8s.cn`都试过,一样的结果.

然后请求`http://192.168.56.11:8000/v2/kube-apiserver/manifests/v1.26.0`尝试反向代理的效果,很遗憾,失败了并且没有任何解决问题的思路.

错误信息:
```shell
2023-02-20 14:07:29.965 [ERR] [connect] invalid target: https://registry.worker.liangyuanpeng.com/v2/
2023-02-20 14:07:29.965 [ERR] [connect] invalid target: https://registry.worker.liangyuanpeng.com/v2/
2023-02-20 14:07:29.965 [ERR] [connect] invalid target: https://registry.worker.liangyuanpeng.com/v2/
2023-02-20 14:08:29.968 [ERR] [connect] invalid target: https://registry.worker.liangyuanpeng.com/v2/
2023-02-20 14:08:29.968 [ERR] [connect] invalid target: https://registry.worker.liangyuanpeng.com/v2/
```

我请求的路径是`/v2/kube-apiserver/manifests/v1.26.0`,而错误提示的路径却是`/v2/`,很奇怪.

这只是我的一个请求转发 hello world,但我拿它没有任何办法 :(

浅尝后我对 flomesh pipy 的看法是:劝退程度很大…

劝退的不是 js 脚本本身的复杂度,而是文档,入门指引性 example 太少. 

而 Pipy 称自身为可编程网关,我更愿意把它叫做"完全编程网关",而把 Envoy 叫做可编程网关.

因为如果你不会写 pipy js 的话,你是没办法使用它的,对于 Envoy 来说,你只有在扩展特定功能点时才需要以编程的方式制作 filter,否则可以直接使用 Envoy 配置文件即可.

# Nginx
# Kong

# 注意 

本文还在持续创作当中.
